/**
 * EXEMPLE DE MIGRATION - InterventionsList avec nouvelle gestion d'erreurs
 * 
 * Changements:
 * 1. Import depuis '../lib/api' au lieu de '../lib/directus'
 * 2. Utilisation du hook useApiCall pour gérer loading/error automatiquement
 * 3. Suppression du try/catch manuel
 * 4. Les erreurs sont affichées via ErrorNotification automatiquement
 */

import { useEffect, useState, useMemo } from "react";
import { Link } from "react-router-dom";
import { XCircle } from "lucide-react";

// ✅ NOUVELLE IMPORTATION
import { fetchInterventions } from "../lib/api";
import { useApiCall } from "../hooks/useApiCall";

import { useAutoRefresh } from "../hooks/useAutoRefresh";
import {
  Container,
  Flex,
  Box,
  Card,
  Heading,
  Text,
  Button,
  Tabs,
  Badge,
  Grid,
} from "@radix-ui/themes";

// Composants
import PageHeader from "../components/layout/PageHeader";
import InterventionStatsCards from "../components/interventions/InterventionStatsCards";
import InterventionGridRow from "../components/interventions/InterventionGridRow";
import InterventionTypeFilter from "../components/interventions/InterventionTypeFilter";

// Utilitaires
import {
  calculateInterventionStats,
  isInterventionOpen
} from "../utils/interventionUtils.jsx";

/**
 * Page principale de gestion des interventions - Avec gestion d'erreurs améliorée
 */
export default function InterventionsListMigrated() {
  // ==================== STATE MANAGEMENT ====================
  const [activeTab, setActiveTab] = useState('active');
  const [selectedType, setSelectedType] = useState(null);
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

  // ✅ UTILISATION DU HOOK useApiCall
  // Gère automatiquement loading, error, et data
  const { 
    data: allInterventions = [], 
    loading, 
    error, 
    execute: refetchInterventions 
  } = useApiCall(fetchInterventions);

  // ==================== COMPUTED VALUES (MEMOIZED) ====================

  const { activeInterventions, closedInterventions } = useMemo(() => {
    const active = allInterventions.filter(isInterventionOpen);
    const closed = allInterventions.filter(i => !isInterventionOpen(i));
    return { activeInterventions: active, closedInterventions: closed };
  }, [allInterventions]);

  const filteredInterventions = useMemo(() => {
    const source = activeTab === 'active' ? activeInterventions : closedInterventions;
    
    if (!selectedType) return source;
    
    return source.filter(i => i.type_inter?.toUpperCase() === selectedType);
  }, [activeInterventions, closedInterventions, activeTab, selectedType]);

  const stats = useMemo(() => {
    return calculateInterventionStats(allInterventions);
  }, [allInterventions]);

  // ==================== AUTO-REFRESH ====================
  
  // ✅ Utiliser directement refetchInterventions du hook
  useAutoRefresh(refetchInterventions, 5);

  // ==================== LIFECYCLE ====================

  useEffect(() => {
    refetchInterventions();
  }, []);

  // Responsive
  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // ==================== EVENT HANDLERS ====================

  const handleTypeChange = (type) => {
    setSelectedType(type === selectedType ? null : type);
  };

  const handleClearFilter = () => {
    setSelectedType(null);
  };

  // ==================== RENDER ====================

  // ✅ Affichage loading simplifié
  if (loading) {
    return (
      <Container size="4">
        <PageHeader
          title="Interventions"
          description="Gestion des interventions de maintenance"
        />
        <Flex justify="center" align="center" style={{ minHeight: '400px' }}>
          <Text size="3">Chargement des interventions...</Text>
        </Flex>
      </Container>
    );
  }

  // ✅ Affichage erreur simplifié
  // Note: L'erreur est aussi affichée via ErrorNotification
  if (error) {
    return (
      <Container size="4">
        <PageHeader
          title="Interventions"
          description="Gestion des interventions de maintenance"
        />
        <Card style={{ background: '#fee', padding: '20px' }}>
          <Flex gap="3" align="center">
            <XCircle color="red" size={24} />
            <Box>
              <Text weight="bold">Erreur de chargement</Text>
              <Text size="2" color="gray">{error.message}</Text>
              <Button 
                size="2" 
                variant="soft" 
                style={{ marginTop: '10px' }}
                onClick={refetchInterventions}
              >
                Réessayer
              </Button>
            </Box>
          </Flex>
        </Card>
      </Container>
    );
  }

  // ✅ Affichage normal
  return (
    <Container size="4">
      <PageHeader
        title="Interventions"
        description="Gestion des interventions de maintenance"
        action={
          <Button asChild size="3">
            <Link to="/interventions/create">+ Nouvelle intervention</Link>
          </Button>
        }
      />

      {/* Stats Cards */}
      <InterventionStatsCards stats={stats} />

      {/* Type Filter */}
      <InterventionTypeFilter
        selectedType={selectedType}
        onTypeChange={handleTypeChange}
        stats={stats}
      />

      {/* Clear Filter Button */}
      {selectedType && (
        <Flex justify="center" style={{ marginBottom: '20px' }}>
          <Button 
            variant="soft" 
            size="2"
            onClick={handleClearFilter}
          >
            <XCircle size={16} />
            Afficher tout
          </Button>
        </Flex>
      )}

      {/* Tabs */}
      <Tabs.Root value={activeTab} onValueChange={setActiveTab}>
        <Tabs.List>
          <Tabs.Trigger value="active">
            Actives
            <Badge color="blue" style={{ marginLeft: '8px' }}>
              {activeInterventions.length}
            </Badge>
          </Tabs.Trigger>
          <Tabs.Trigger value="closed">
            Fermées
            <Badge color="gray" style={{ marginLeft: '8px' }}>
              {closedInterventions.length}
            </Badge>
          </Tabs.Trigger>
        </Tabs.List>

        <Box style={{ marginTop: '20px' }}>
          {filteredInterventions.length === 0 ? (
            <Card>
              <Text color="gray" align="center">
                Aucune intervention trouvée
              </Text>
            </Card>
          ) : (
            <Grid columns={{ initial: "1", md: "2", lg: "3" }} gap="4">
              {filteredInterventions.map((intervention) => (
                <InterventionGridRow
                  key={intervention.id}
                  intervention={intervention}
                />
              ))}
            </Grid>
          )}
        </Box>
      </Tabs.Root>
    </Container>
  );
}
