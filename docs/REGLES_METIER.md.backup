## Gestion des demandes d'intervention et des sous-tÃ¢ches

> **Note importante** : Ce document dÃ©finit le **modÃ¨le mÃ©tier cible** de Tunnel GMAO.  
> Certaines rÃ¨gles dÃ©crites ici **ne sont pas encore implÃ©mentÃ©es techniquement**, mais elles
> font partie intÃ©grante des rÃ¨gles mÃ©tier et doivent guider toute Ã©volution
> du modÃ¨le de donnÃ©es et du code.

---

### Demande dâ€™intervention (Request)

#### RÃ´le mÃ©tier

La demande dâ€™intervention est le **point dâ€™entrÃ©e unique** dâ€™un besoin de maintenance.
Elle sert Ã  :

- signaler un problÃ¨me ou un besoin
- qualifier la demande
- dÃ©cider de sa prise en charge

#### RÃ¨gles mÃ©tier

- Une demande peut exister **sans intervention**
- Une demande **ne contient jamais** :
  - de temps passÃ©
  - dâ€™actions
  - de piÃ¨ces
- Une demande peut Ãªtre :
  - acceptÃ©e
  - rejetÃ©e
  - clÃ´turÃ©e sans intervention
- Une demande acceptÃ©e peut gÃ©nÃ©rer **une seule et unique intervention**

#### Statuts cibles (MVP)

> **Ã€ dÃ©finir selon la mise en Å“uvre concrÃ¨te**  
> Exemples possibles : `nouvelle`, `en_qualification`, `acceptÃ©e`, `rejetÃ©e`, `clÃ´turÃ©e`

---

### Intervention

#### RÃ´le mÃ©tier

L'intervention est le **point d'entrÃ©e principal** de la maintenance.
Elle reprÃ©sente **l'exÃ©cution rÃ©elle du travail de maintenance** sur un Ã©quipement.

#### RÃ¨gles mÃ©tier

- Une intervention est **toujours rattachÃ©e Ã  une machine** (obligatoire)
- Une intervention possÃ¨de un **code unique auto-gÃ©nÃ©rÃ©** : `MACHINE-TYPE-YYYYMMDD-INITIALES`
  - Exemple : `CONV01-PREV-20241228-JD`
- Une intervention peut Ãªtre de diffÃ©rents types : `PREV` (prÃ©ventif), `COR` (correctif), `INST` (installation), etc.
- Toute action terrain est rattachÃ©e Ã  une intervention
- Une intervention passe par diffÃ©rents **statuts** : `ouvert`, `en_cours`, `ferme`, `annule`
- Chaque changement de statut est **automatiquement historisÃ©** dans `intervention_status_log`

#### RÃ¨gles fortes

- Il est obligatoire de prÃ©ciser la machine concernÃ©e (`machine_id`)
- Le code intervention est gÃ©nÃ©rÃ© automatiquement et ne peut pas Ãªtre modifiÃ© manuellement
- Les dates (`date_debut`, `date_fin`) dÃ©limitent la pÃ©riode d'exÃ©cution
- Le statut actuel est synchronisÃ© automatiquement avec l'historique des changements de statut

---

### Sous-tÃ¢ches (Subtasks)

#### RÃ´le mÃ©tier

Les sous-tÃ¢ches servent **exclusivement Ã  organiser le travail** lors :

- dâ€™interventions longues
- de projets
- de mises en service

#### RÃ¨gles mÃ©tier

- Une sous-tÃ¢che est toujours rattachÃ©e Ã  une intervention
- Une sous-tÃ¢che nâ€™a **aucune valeur de traÃ§abilitÃ© terrain**
- Une sous-tÃ¢che ne contient :
  - ni temps passÃ©
  - ni piÃ¨ces
  - ni complexitÃ©
- Les statistiques et indicateurs **ne tiennent jamais compte des sous-tÃ¢ches**

#### Statuts cibles

> **Ã€ dÃ©finir selon la mise en Å“uvre concrÃ¨te**  
> Exemples possibles : `en_cours`, `attente_pieces`, `attente_prod`, `terminÃ©e`, `annulÃ©e`

---

### Actions

#### RÃ´le mÃ©tier

L'action (`intervention_action`) est la **seule unitÃ© de travail rÃ©el** et de traÃ§abilitÃ© terrain.

#### RÃ¨gles mÃ©tier

- Une action est **toujours rattachÃ©e Ã  une intervention** (`intervention_id` obligatoire)
- Une action est **classifiÃ©e par sous-catÃ©gorie** (`action_subcategory` â†’ catÃ©gorie parent avec couleur)
- Une action possÃ¨de :
  - Une **description** libre du travail effectuÃ©
  - Un **temps passÃ©** (`time_spent` en heures) - **seule source de vÃ©ritÃ©**
  - Une **complexitÃ©** (`complexity` : simple, moyen, Ã©levÃ©, critique)
  - Une **prioritÃ©** (`priority` : basse, normale, haute, critique)
  - Un **technicien** ayant rÃ©alisÃ© l'action (`tech`)

#### RÃ¨gles fortes

- Le temps et la complexitÃ© sont portÃ©s **uniquement par les actions**
- Toutes les statistiques et KPI sont calculÃ©s **Ã  partir des actions**
- Les actions sont horodatÃ©es (`created_at`, `updated_at`)
- Une action ne peut pas exister sans intervention parente

#### Classification des actions

Les actions sont organisÃ©es en **catÃ©gories** et **sous-catÃ©gories** :

- **CatÃ©gories** (exemples) : DEP (DÃ©pannage), FAB (Fabrication), PREV (PrÃ©ventif), SUP (Support/Administratif), BAT (BÃ¢timent/Nettoyage)
- Chaque catÃ©gorie a une **couleur hexadÃ©cimale** pour l'UI (badges)
- Les **sous-catÃ©gories** affinent la classification (ex : DEP_ELEC, DEP_MECA, PREV_GRAIS, SUP_INV)

---

### PiÃ¨ces consommÃ©es

#### RÃ´le mÃ©tier

Les piÃ¨ces consommÃ©es durant interventions sont tracÃ©es via `intervention_part`.

#### RÃ¨gles mÃ©tier

- Une piÃ¨ce consommÃ©e est rattachÃ©e Ã  une **intervention** (`intervention_id`)
- Lien avec les articles stock (`stock_item_id`)
- QuantitÃ© consommÃ©e enregistrÃ©e (`quantity`)
- Notes optionnelles pour contexte

---

### RÃ¨gle mÃ©tier synthÃ¨se (non nÃ©gociable)

| RÃ¨gle                         | Description                                                      | ImplÃ©mentation |
| ----------------------------- | ---------------------------------------------------------------- | -------------- |
| **Intervention = point entrÃ©e** | L'intervention est le point d'entrÃ©e principal de la maintenance | âœ… ImplÃ©mentÃ©  |
| **Machine obligatoire**       | Toute intervention doit Ãªtre rattachÃ©e Ã  une machine             | âœ… ImplÃ©mentÃ©  |
| **Sous-tÃ¢che = organisation** | Une sous-tÃ¢che est un outil d'organisation, pas de traÃ§abilitÃ©   | âœ… ImplÃ©mentÃ©  |
| **Action = preuve**           | Une action est la seule preuve de travail rÃ©el                   | âœ… ImplÃ©mentÃ©  |
| **Temps dans l'action**       | Le temps et la complexitÃ© vivent uniquement dans les actions     | âœ… ImplÃ©mentÃ©  |
| **Code auto-gÃ©nÃ©rÃ©**          | Les codes intervention, stock, commandes sont auto-gÃ©nÃ©rÃ©s       | âœ… Triggers    |
| **Historisation statuts**     | Tout changement de statut est automatiquement historisÃ©          | âœ… Triggers    |

### Impact sur l'architecture techniqueschÃ©ma PostgreSQL par :

1. **ModÃ¨le de donnÃ©es** (voir [db/schema/](../db/schema/))

   - Table `intervention` : point d'entrÃ©e principal
     - `machine_id` (UUID, FK vers `machine`) - obligatoire
     - `code` (VARCHAR) - auto-gÃ©nÃ©rÃ© par trigger `trg_interv_code`
     - `type_inter` (VARCHAR) - type intervention
     - `status_actual` (VARCHAR, FK vers `intervention_status_ref`)
   - Table `intervention_action` : unitÃ© de travail rÃ©el
     - `intervention_id` (UUID, FK vers `intervention`) - obligatoire
     - `action_subcategory` (INTEGER, FK vers `action_subcategory`)
     - `time_spent` (NUMERIC) - temps en heures
     - `complexity` (VARCHAR) - niveau complexitÃ©
     - `priority` (VARCHAR) - prioritÃ©
     - `tech` (UUID) - technicien
   - Table `subtask` : organisation interne
     - `intervention_id` (UUID, FK vers `intervention`)
     - `description` (TEXT), `status` (VARCHAR), `assigned_to` (UUID)
     - **Aucun champ temps/complexitÃ©** (organisation uniquement)
   - Table `intervention_status_log` : historique automatique
     - AlimentÃ©e par triggers `trg_init_status_log` et `trg_log_status_change`

2. **Automatisations PostgreSQL** (triggers)

   - **GÃ©nÃ©ration codes** :
     - `trg_interv_code` : Code intervention `MACHINE-TYPE-YYYYMMDD-INITIALES`
     - `trg_generate_stock_item_ref` : RÃ©fÃ©rence stock `FAM-SFAM-SPEC-DIM`
     - `trg_generate_supplier_order_number` : NumÃ©ro commande `CMD-YYYYMMDD-NNNN`
   - **Historisation statuts** :
     - `trg_init_status_log` : Log initial Ã  la crÃ©ation (statut "ouvert")
     - `trg_log_status_change` : Log automatique Ã  chaque changement statut
     - `trg_sync_status_from_log` : Synchronisation `status_actual` depuis log
   - **Calculs automatiques** :
     - `trg_calculate_line_total` : Total ligne commande (prix Ã— quantitÃ©)
     - `update_updated_at_column` : Timestamps `updated_at`

3. **Validation backend**

   - CrÃ©ation intervention : `machine_id` obligatoire
   - CrÃ©ation action : `intervention_id` obligatoire
   - Temps/complexitÃ© : uniquement dans `intervention_action`
   - Codes auto-gÃ©nÃ©rÃ©s : interdiction modification manuelle

4. **Interface utilisateur**

   - Workflow : Machine â†’ Intervention â†’ Actions
   - Statistiques calculÃ©es **uniquement sur actions** (ignorer sous-tÃ¢ches)
   - Sous-tÃ¢ches affichÃ©es comme checklist organisationnelle
   - Badges colorÃ©s catÃ©gories (couleurs hex depuis `action_category.color`)

5. **API contracts (DTOs)**
   - `Intervention` : inclure `machine: { id, code, nom }`, `status_actual`, `code`
   - `InterventionAction` : inclure `timeSpent`, `complexity`, `priority`, `subcategory.category.color`
   - `Subtask` : DTO simple sans champs analytiques (organisation uniquement)
   - Pas de DTO `InterventionRequest` (non implÃ©mentÃ© dans schÃ©ma actuel)

> ğŸ“– Voir [tech/API_CONTRACTS.md](tech/API_CONTRACTS.md) pour les contrats DTOs dÃ©taillÃ©s  
> ğŸ“– Voir [db/schema/README.md](../db/schema/README.md) pour la documentation du schÃ©ma SQL

> ğŸ“– Voir [tech/API_CONTRACTS.md](tech/API_CONTRACTS.md) pour les contrats dÃ©taillÃ©s
